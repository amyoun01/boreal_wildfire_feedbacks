---
title: "select_regression_predictors"
output:
  pdf_document: default
  html_document: default
date: "`r Sys.Date()`"
---

First, let's read in data.frames for annaul area burned and climate. Also import
the 'car' library for regression diagnostic calculations

```{r Read in files and required libraries, include = TRUE}
suppressPackageStartupMessages(library(car))
suppressPackageStartupMessages(library(data.table))

aab <- read.csv("../data/dataframes/annual_area_burned.csv")
cffdrs_vars <- read.csv("../data/dataframes/cffdrs-stats_era5_1979-2020.csv")
```

Now let's just check a quick summary for some of the variables in each of these 
datasets for the Alaskan ecoregion (50607).  

```{r include = TRUE}
summary(aab$annual_area_burned_km2[aab$ecos == 50607.0])
summary(cffdrs_vars$bui_95d[aab$ecos == 50607.0])
summary(cffdrs_vars$isi_max[aab$ecos == 50607.0])

# Merge datasets together using data.table
data_table <- data.table::merge.data.table(cffdrs_vars, aab, 
                                           by = c("year", "ecos"))

# Rename "annual_area_burned_km2" -> "aab
colnames(data_table)[15] <- "aab"

```

Now, we want to create a list of model formulas that will be used for modeling
aab in each ecoregion. This list of formulas will combine all possible
bui and isi predictors so we can identify which specific combinations of
explanatory variables should be used in a given ecoregion.

```{r include = TRUE}
# Before we do this make sure to set any aab values < 4 km2 to a random uniform
# variable to help remove zeros.
id <- data_table$aab < 4
data_table$aab[id] <- runif(sum(id), 0, 4)

# Unique ecoregions
ecos = unique(data_table$ecos)

# Variables for CFFDDRS summaries: 
# 1. max: Annual maximum anomaly relative 1980-2009
# 2. 95d: Number of days in a given year that exceed historical (1980-2009) 
#    95th percentile
# 3. fs: Max value from a 90-day moving window over each year
# 4. fwsl: The number of days in the fire season calculated from 
#    Jolly et all 2015 Nature Comms
stats <- c("max", "95d", "fs", "fwsl")

mdl_forms <- c()

for (i in 1:length(stats)){
  for (j in 1:length(stats)){
    mdl_forms <- c(mdl_forms,paste0("aab ~ isi_", stats[i], 
                                    " + bui_", stats[j]))
  }
}

# Print first four formulas to examine and make sure it's working
print(mdl_forms[1:4])
```
  
The next step is to calculate a set of diagnostics for each set of explanatory
variables, this includes AIC, BIC, Deviance, R-squared, and Variance Inflation 
Factor
  
```{r include = TRUE}
# Make data.frame to store results
diagnostics <- data.frame(ecos = numeric(),
                          mdl = character(),
                          AIC = numeric(),
                          BIC = numeric(),
                          Dev = numeric(),
                          R2 = numeric(),
                          vif = numeric())
```

In a nested for loop, go through and calculate each of the above diagnostics

```{r include = TRUE}

for (i in seq_along(ecos)){

  eco_id <- data_table$ecos == ecos[i]
  
  for (j in seq_along(mdl_forms)){
  
    glm_ij <- glm(mdl_forms[j],
                  family = Gamma(link = "log"),
                  data = data_table,
                  subset = eco_id)
    
    aic <- AIC(glm_ij)
    bic <- BIC(glm_ij)
    dev <- glm_ij$deviance
    dev.null <- glm_ij$null.deviance
    R2 <- 1 - dev / dev.null
    VIF <- car::vif(glm_ij)[1]
    
    df_ij <- data.frame(ecos = ecos[i],
                        mdl = mdl_forms[j],
                        AIC = aic,
                        BIC = bic,
                        Dev = dev,
                        R2 = R2,
                        vif = VIF)
    
    diagnostics <- rbind(diagnostics, df_ij, make.row.names = FALSE)
  
  }
  
}

```

Before we identify best models based on BIC and R2, remove models with high 
covariance among the predictors using VIF < 3 as a cutoff.

```{r}
vif.id <- diagnostics$vif < 3
diagnostics <- diagnostics[vif.id, ]
```

In the following code, we fill in two empty vectors to hold the index of which
models produced the lowest BIC and max R2 for each ecoregion. 

```{r}
min_bic_id <- numeric(length = length(ecos))
  
for (i in seq_along(ecos)){
  
  ecos.id <- which(diagnostics$ecos == ecos[i])
  bic.id <- which(diagnostics$BIC[ecos.id] == min(diagnostics$BIC[ecos.id]))
  
  min_bic_id[i] <- ecos.id[bic.id]

}

print(diagnostics[min_bic_id, ])
```
We now have an estimate of the best predictors to use for each ecoregion. We now
want to export these results for use in the models

```{r include = TRUE}
write.csv(diagnostics[min_bic_id, ],
          "../data/dataframes/regression_predictors.csv",
          row.names = FALSE)

```